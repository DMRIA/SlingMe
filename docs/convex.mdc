# Slingshot Rental / SlingMe – Convex Backend Spec

Last updated: 2025-12-10  
Owner: Devin Mausia  

This document defines the data model and function conventions for the Convex backend.

---

## 1. Domains

Domains and corresponding tables:

1. Users – `users`
2. Locations – `locations`
3. Vehicles / Fleet – `vehicles`
4. Availability – `availability`
5. Rentals / Bookings – `rentals`
6. Pricing Rules – `pricing_rules`
7. Maintenance – `maintenance_events`
8. Reviews & Feedback – `reviews`
9. Agent Telemetry – `agent_runs`

---

## 2. Tables (conceptual)

See conversation notes for full details; this is a concise summary.

### 2.1 users

- `email` (unique), `phone`, `name`
- Driver info: license number/state/expiration, dob, age_verified
- `default_location_id`, `is_admin`
- `created_at`, `updated_at`

### 2.2 locations

- `name`, `address`, `city`, `state`, `zip`
- `lat`, `lng`
- `is_active`, timestamps

### 2.3 vehicles

- `name`, `slug`
- `location_id`
- `plate_number`, `vin`
- `color`, `seat_count`, `transmission`
- `photo_urls`
- `base_hourly_rate`, `base_daily_rate`
- `status` (available, booked, in_maintenance, retired)
- timestamps

### 2.4 availability

- `vehicle_id`
- `date`
- `start_time`, `end_time`
- `type` (open | blocked)
- `reason`
- timestamps

### 2.5 rentals

- `user_id`, `vehicle_id`, `location_id`
- `start_time`, `end_time`
- `status` (pending, confirmed, in_progress, completed, canceled, no_show)
- `price_quote_id`, `final_price`, `currency`
- `payment_status` (unpaid, pending, paid, refunded)
- `payment_provider` (venmo, stripe, etc.)
- `waiver_signed`, `waiver_reference`
- `notes_internal`
- timestamps

### 2.6 pricing_rules

- `name`, `description`
- `vehicle_id`, `location_id`
- `day_of_week`, `start_date`, `end_date`
- `hourly_multiplier`, `daily_multiplier`
- `min_price`, `max_price`
- `is_active`
- timestamps

### 2.7 maintenance_events

- `vehicle_id`
- `type`
- `scheduled_at`, `started_at`, `completed_at`
- `notes`
- timestamps

### 2.8 reviews

- `rental_id`, `user_id`, `vehicle_id`
- `rating`, `comment`
- `created_at`

### 2.9 agent_runs

- `agent_name`, `session_id`, `user_id`
- `input_summary`, `output_summary`
- `status`
- `metadata` (JSON)
- `created_at`

---

## 3. Convex Folder Layout

Recommended layout under `convex/`:

- `schema.ts`
- `rentals/`
  - `createRental.ts`
  - `getUserRentals.ts`
  - `cancelRental.ts`
- `availability/`
  - `getAvailability.ts`
  - `blockAvailability.ts`
- `pricing/`
  - `getQuote.ts`
  - `listPricingRules.ts`
  - `updatePricingRule.ts`
- `fleet/`
  - `listVehicles.ts`
  - `updateVehicleStatus.ts`
- `locations/`
  - `listLocations.ts`
- `maintenance/`
  - `listMaintenanceEvents.ts`
  - `createMaintenanceEvent.ts`
- `reviews/`
  - `createReview.ts`
  - `listReviews.ts`
- `actions/`
  - `sendSmsReminder.ts`
  - `syncStripePayment.ts` (later)
- `internal/`
  - shared helpers (time utils, pricing engine)

---

## 4. Tool Contracts for Agents

Functions to be exposed as tools:

- Booking:
  - `convex.getAvailability(...)`
  - `convex.getQuote(...)`
  - `convex.createRental(...)`
  - `convex.getUserRentals(user_id)`
  - `convex.getWaiverStatus(user_id)`

- Pricing:
  - `convex.fetchRecentRentals(window_days)`
  - `convex.listPricingRules(filters)`
  - `convex.updatePricingRule(rule_id, new_rule)`

- Fleet:
  - `convex.listVehicles(filters)`
  - `convex.updateVehicleStatus(vehicle_id, status)`
  - `convex.blockAvailability(vehicle_id, date_range, reason)`
  - `convex.listMaintenanceEvents(filters)`
  - `convex.createMaintenanceEvent(...)`

- Support & reviews:
  - `convex.getRental(rental_id)`
  - `convex.getReviews(filters)`
  - `convex.createSupportTicket(user_id, category, message)`
  - `convex.createReview(rental_id, rating, comment?)`

- Telemetry:
  - `convex.logAgentRun(...)`

This spec should guide the implementation in `schema.ts` and the Convex modules.
